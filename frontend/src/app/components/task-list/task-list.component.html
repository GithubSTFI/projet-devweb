<div class="task-page" [@staggerList]>
    <!-- TABLE CONTAINER -->
    <div class="table-container">
        <!-- HEADER WITH FILTERS, SEARCH & NEW BUTTON -->
        <div class="table-header">
            <div class="header-left">
                <div class="filter-group">
                    <span class="filter-label">Statut</span>
                    <div class="filter-tabs">
                        <button *ngFor="let f of filters" (click)="setFilter(f.value)"
                            [class.active]="filter() === f.value" class="filter-tab">
                            {{ f.label }}
                        </button>
                    </div>
                </div>

                <div class="filter-group">
                    <span class="filter-label">Priorité</span>
                    <div class="filter-tabs priority-tabs">
                        <button *ngFor="let p of priorities" (click)="setPriority(p.value)"
                            [class.active]="priorityFilter() === p.value" class="filter-tab">
                            {{ p.label }}
                        </button>
                    </div>
                </div>

                <div class="search-bar">
                    <span class="material-icons">search</span>
                    <input type="text" [ngModel]="searchQuery()" (input)="onSearch($event)"
                        placeholder="Rechercher par mot-clé...">
                </div>
            </div>

            <div class="header-right">
                <div class="view-toggle">
                    <button [class.active]="viewMode() === 'list'" (click)="setViewMode('list')" title="Vue Liste">
                        <span class="material-icons">format_list_bulleted</span>
                    </button>
                    <button [class.active]="viewMode() === 'kanban'" (click)="setViewMode('kanban')" title="Vue Kanban">
                        <span class="material-icons">view_kanban</span>
                    </button>
                </div>

                <button class="new-task-btn" (click)="openNewTask()">
                    <span class="material-icons">add</span>
                    <span>Nouvelle Tâche</span>
                </button>
            </div>
        </div>

        <!-- TASK CONTENT (LIST OR KANBAN) -->
        <div class="task-content">
            <!-- LOADER -->
            <app-loader *ngIf="isLoading()" message="Chargement des tâches..."></app-loader>

            <!-- LIST VIEW -->
            <div *ngIf="viewMode() === 'list' && !isLoading()" class="task-table">
                <div class="table-row table-head">
                    <div class="col-check"></div>
                    <div class="col-title">Titre</div>
                    <div class="col-priority">Priorité</div>
                    <div class="col-status">Statut</div>
                    <div class="col-actions">Actions</div>
                </div>

                <div *ngFor="let task of tasks()" class="table-row stagger-row" (click)="openDetail(task)">
                    <div class="col-check" (click)="$event.stopPropagation()">
                        <div class="task-check" [class.checked]="task.status === 'DONE'" (click)="toggleStatus(task)">
                            <span class="material-icons" *ngIf="task.status === 'DONE'">check</span>
                        </div>
                    </div>

                    <div class="col-title">
                        <div class="title-wrapper">
                            <span class="task-title-text" [class.done]="task.status === 'DONE'">{{ task.title }}</span>
                            <span class="overdue-badge" *ngIf="isOverdue(task)">
                                <span class="material-icons">priority_high</span> En retard
                            </span>
                        </div>
                    </div>

                    <div class="col-priority">
                        <span class="priority-badge" [ngClass]="task.priority.toLowerCase()">
                            {{ getPriorityLabel(task.priority) }}
                        </span>
                    </div>

                    <div class="col-status">
                        <span class="status-badge" [ngClass]="task.status.toLowerCase()">
                            {{ getStatusLabel(task.status) }}
                        </span>
                    </div>

                    <div class="col-actions">
                        <button class="btn-delete" (click)="deleteTask(task.id); $event.stopPropagation()">
                            <span class="material-icons">delete_outline</span>
                        </button>
                    </div>
                </div>

                <!-- PAGINATION PREMIUM -->
                <div class="pagination-premium" *ngIf="totalPages() > 1">
                    <button [disabled]="page() === 1" (click)="prevPage()" class="page-nav-btn">
                        <span class="material-icons">chevron_left</span>
                    </button>

                    <div class="page-numbers">
                        <span class="page-info">Page <strong>{{ page() }}</strong> sur {{ totalPages() }}</span>
                    </div>

                    <button [disabled]="page() === totalPages()" (click)="nextPage()" class="page-nav-btn">
                        <span class="material-icons">chevron_right</span>
                    </button>
                </div>
            </div>

            <!-- KANBAN VIEW -->
            <app-kanban-view *ngIf="viewMode() === 'kanban' && !isLoading()" [tasks]="tasks()"
                (taskUpdated)="loadTasks()">
            </app-kanban-view>

            <!-- EMPTY STATE -->
            <div *ngIf="tasks().length === 0 && !isLoading()" class="empty-state">
                <span class="material-icons">inbox</span>
                <p>{{ searchQuery() ? 'Aucun résultat pour cette recherche' : 'Aucune tâche trouvée' }}</p>
                <button *ngIf="!searchQuery()" (click)="openNewTask()" class="create-first-btn">Créer votre première
                    tâche</button>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <app-task-detail *ngIf="showModal" [task]="selectedTask" [isNew]="isNewMode" (closeEvent)="closeModal()"
        (updateEvent)="refresh()"></app-task-detail>

    <!-- CONFIRM DIALOG -->
    <app-confirm-dialog *ngIf="showConfirmDialog" [title]="'Supprimer la tâche'"
        [message]="'Êtes-vous sûr de vouloir supprimer cette tâche ? Cette action est irréversible.'"
        [confirmText]="'Supprimer'" [cancelText]="'Annuler'" [icon]="'delete_outline'" (confirm)="confirmDelete()"
        (cancel)="cancelDelete()"></app-confirm-dialog>
</div>