<app-loader *ngIf="isLoading()" message="Chargement de vos statistiques..."></app-loader>

<div class="overview-container" *ngIf="!isLoading() && stats()">
    <!-- Welcome Section -->
    <div class="welcome-card">
        <div class="welcome-text">
            <h1>Bienvenue, {{ user()?.username }} üëã</h1>
            <p *ngIf="role() === 'USER'">Voici un aper√ßu de vos t√¢ches et de votre productivit√©.</p>
            <p *ngIf="role() === 'ADMIN'">Panneau d'administration - Vue globale du syst√®me.</p>
        </div>
    </div>

    <!-- Stats Grid for USER -->
    <div class="stats-grid" *ngIf="role() === 'USER'">
        <div class="stat-card total">
            <div class="stat-icon"><span class="material-icons">task</span></div>
            <div class="stat-info">
                <span class="stat-value">{{ stats().total }}</span>
                <span class="stat-label">Total</span>
            </div>
        </div>
        <div class="stat-card done">
            <div class="stat-icon"><span class="material-icons">check_circle</span></div>
            <div class="stat-info">
                <span class="stat-value">{{ stats().done }}</span>
                <span class="stat-label">Termin√©es</span>
            </div>
        </div>
        <div class="stat-card danger" [class.active]="stats().overdue > 0">
            <div class="stat-icon"><span class="material-icons">priority_high</span></div>
            <div class="stat-info">
                <span class="stat-value">{{ stats().overdue }}</span>
                <span class="stat-label">En retard</span>
            </div>
        </div>
        <div class="stat-card assigned">
            <div class="stat-icon"><span class="material-icons">group</span></div>
            <div class="stat-info">
                <span class="stat-value">{{ stats().assigned }}</span>
                <span class="stat-label">Assign√©es</span>
            </div>
        </div>
    </div>

    <!-- Stats Grid for ADMIN -->
    <div class="stats-grid" *ngIf="role() === 'ADMIN'">
        <div class="stat-card total">
            <div class="stat-icon"><span class="material-icons">groups</span></div>
            <div class="stat-info">
                <span class="stat-value">{{ stats().totalUsers }}</span>
                <span class="stat-label">Utilisateurs</span>
            </div>
        </div>
        <div class="stat-card progress">
            <div class="stat-icon"><span class="material-icons">assignment</span></div>
            <div class="stat-info">
                <span class="stat-value">{{ stats().totalTasks }}</span>
                <span class="stat-label">T√¢ches globales</span>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Body -->
    <div class="dashboard-grid full-width-grid">
        <!-- TOP: PROJECTS SNIPPET -->
        <div class="project-groups-container full-width">
            <div class="group-header">
                <div class="left-h">
                    <h2><span class="material-icons">folder_special</span> Vue par Projet</h2>
                    <p>Vos projets r√©cents</p>
                </div>
                <a routerLink="/dashboard/projects" class="view-all-link">Voir tous les projets <span
                        class="material-icons">east</span></a>
            </div>

            <div class="projects-kanban-preview">
                <!-- Card for each project (Limit to 3) -->
                <div class="project-group-card" *ngFor="let p of projects().slice(0, 3)"
                    [style.border-top-color]="p.color">
                    <div class="pg-header" [routerLink]="['/dashboard/projects', p.id]">
                        <div class="pg-title">
                            <span class="pg-dot" [style.background]="p.color"></span>
                            <h3>{{ p.name }}</h3>
                        </div>
                        <span class="material-icons">open_in_new</span>
                    </div>

                    <div class="pg-tasks">
                        <div class="pg-task-item" *ngFor="let t of (p.tasks || []).slice(0, 3)"
                            [routerLink]="['/dashboard/projects', p.id]">
                            <span class="t-status" [class]="t.status"></span>
                            <div class="t-content">
                                <span class="t-title">{{ t.title }}</span>
                            </div>
                        </div>
                        <div *ngIf="!p.tasks?.length" class="empty-pg">
                            Aucune t√¢che pour le moment
                        </div>
                    </div>

                    <div class="pg-footer" [routerLink]="['/dashboard/projects', p.id]">
                        <span>{{ p.tasks?.length || 0 }} t√¢ches au total</span>
                        <span class="view-more">D√©tails <span class="material-icons">arrow_forward</span></span>
                    </div>
                </div>

                <!-- Simple Add CTA if less than 1 project -->
                <div class="project-group-card add-project-cta mini" *ngIf="projects().length === 0"
                    routerLink="/dashboard/projects">
                    <span class="material-icons">add</span>
                    <h3>Nouveau Projet</h3>
                </div>
            </div>
        </div>

        <!-- BELOW: TWO COLUMNS (TASKS | CHART) -->
        <div class="tasks-column">
            <div class="card-premium">
                <div class="card-header">
                    <h2><span class="material-icons">event_note</span> T√¢ches r√©centes</h2>
                    <a routerLink="/dashboard/tasks" class="view-all">Voir tout ‚Üí</a>
                </div>
                <div class="task-mini-list">
                    <div class="task-mini-item" *ngFor="let task of recentTasks().slice(0, 6)">
                        <span class="status-dot" [class]="'status-' + task.status"></span>
                        <div class="task-details">
                            <span class="task-title">{{ task.title }}</span>
                            <span class="task-owner" *ngIf="task.owner?.id !== user()?.id">Par {{ task.owner?.username
                                }}</span>
                        </div>
                        <span class="task-time">{{ formatDate(task.createdAt) }}</span>
                    </div>
                    <div *ngIf="recentTasks().length === 0" class="empty-state">
                        <p>Aucune t√¢che r√©cente</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-activity-column">
            <div class="card-premium">
                <div class="card-header">
                    <h2><span class="material-icons">pie_chart</span> R√©partition</h2>
                </div>
                <div class="chart-wrapper">
                    <canvas #taskChart></canvas>
                </div>
            </div>

            <!-- ADMIN Only Activity below the chart if needed, or separate row -->
            <div class="card-premium compact-act" *ngIf="role() === 'ADMIN'">
                <div class="card-header">
                    <h2><span class="material-icons">history</span> Activit√©</h2>
                </div>
                <div class="activity-list-compact">
                    <div class="activity-item" *ngFor="let log of recentActivities().slice(0, 4)">
                        <div class="act-details">
                            <span class="act-user">{{ log.user?.username }}</span>
                            <span class="act-text">{{ log.action }}</span>
                        </div>
                        <span class="act-time">{{ formatDate(log.createdAt) }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>