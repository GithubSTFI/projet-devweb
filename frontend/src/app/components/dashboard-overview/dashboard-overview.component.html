<app-loader *ngIf="isLoading()" message="Chargement de vos statistiques..."></app-loader>

<div class="overview-container" *ngIf="!isLoading() && stats()">
    <!-- Welcome Section -->
    <div class="welcome-card">
        <div class="welcome-text">
            <h1>Bienvenue, {{ user()?.username }} üëã</h1>
            <p *ngIf="role() === 'USER'">Voici un aper√ßu de vos t√¢ches et de votre productivit√©.</p>
            <p *ngIf="role() === 'ADMIN'">Panneau d'administration - Vue globale du syst√®me.</p>
        </div>
    </div>

    <!-- Stats Grid for USER -->
    <div class="stats-grid" *ngIf="role() === 'USER'">
        <div class="stat-card total">
            <div class="stat-icon"><span class="material-icons">task</span></div>
            <div class="stat-info">
                <span class="stat-value">{{ stats().total }}</span>
                <span class="stat-label">Total</span>
            </div>
        </div>
        <div class="stat-card done">
            <div class="stat-icon"><span class="material-icons">check_circle</span></div>
            <div class="stat-info">
                <span class="stat-value">{{ stats().done }}</span>
                <span class="stat-label">Termin√©es</span>
            </div>
        </div>
        <div class="stat-card danger" [class.active]="stats().overdue > 0">
            <div class="stat-icon"><span class="material-icons">priority_high</span></div>
            <div class="stat-info">
                <span class="stat-value">{{ stats().overdue }}</span>
                <span class="stat-label">En retard</span>
            </div>
        </div>
        <div class="stat-card assigned">
            <div class="stat-icon"><span class="material-icons">group</span></div>
            <div class="stat-info">
                <span class="stat-value">{{ stats().assigned }}</span>
                <span class="stat-label">Assign√©es</span>
            </div>
        </div>
    </div>

    <!-- Stats Grid for ADMIN -->
    <div class="stats-grid" *ngIf="role() === 'ADMIN'">
        <div class="stat-card total">
            <div class="stat-icon"><span class="material-icons">groups</span></div>
            <div class="stat-info">
                <span class="stat-value">{{ stats().totalUsers }}</span>
                <span class="stat-label">Utilisateurs</span>
            </div>
        </div>
        <div class="stat-card progress">
            <div class="stat-icon"><span class="material-icons">assignment</span></div>
            <div class="stat-info">
                <span class="stat-value">{{ stats().totalTasks }}</span>
                <span class="stat-label">T√¢ches globales</span>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Body -->
    <div class="dashboard-grid">
        <!-- USER VIEW: Recent Tasks & Chart -->
        <ng-container *ngIf="role() === 'USER'">
            <div class="card-premium">
                <div class="card-header">
                    <h2><span class="material-icons">event_note</span> T√¢ches r√©centes</h2>
                    <a routerLink="/dashboard/tasks" class="view-all">Voir tout ‚Üí</a>
                </div>
                <div class="task-mini-list">
                    <div class="task-mini-item" *ngFor="let task of recentTasks()">
                        <span class="status-dot" [class]="'status-' + task.status"></span>
                        <div class="task-details">
                            <span class="task-title">{{ task.title }}</span>
                            <span class="task-owner" *ngIf="task.owner?.id !== user()?.id">Par {{ task.owner?.username
                                }}</span>
                        </div>
                        <span class="task-time">{{ formatDate(task.createdAt) }}</span>
                    </div>
                </div>
            </div>

            <div class="card-premium">
                <div class="card-header">
                    <h2><span class="material-icons">pie_chart</span> R√©partition</h2>
                </div>
                <div class="chart-wrapper">
                    <canvas #taskChart></canvas>
                </div>
            </div>
        </ng-container>

        <!-- ADMIN VIEW: Activity Logs & Chart -->
        <ng-container *ngIf="role() === 'ADMIN'">
            <div class="card-premium">
                <div class="card-header">
                    <h2><span class="material-icons">history</span> Journal d'activit√©</h2>
                    <a routerLink="/dashboard/admin/logs" class="view-all">D√©tails ‚Üí</a>
                </div>
                <div class="activity-list">
                    <div class="activity-item" *ngFor="let log of recentActivities()">
                        <div class="act-left">
                            <span class="activity-user">{{ log.user?.username }}</span>
                            <span class="activity-action">{{ log.action }}</span>
                        </div>
                        <span class="activity-time">{{ formatDate(log.createdAt) }}</span>
                    </div>
                </div>
            </div>

            <div class="card-premium">
                <div class="card-header">
                    <h2><span class="material-icons">pie_chart</span> √âtats Globaux</h2>
                </div>
                <div class="chart-wrapper">
                    <canvas #taskChart></canvas>
                </div>
            </div>
        </ng-container>
    </div>
</div>