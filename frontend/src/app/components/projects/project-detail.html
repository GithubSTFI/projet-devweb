<div class="project-detail-container fade-in" *ngIf="project()">
    <!-- Header with Background & Info -->
    <div class="project-header">
        <div class="header-overlay" [style.background]="project()?.color"></div>
        <div class="header-content">
            <div class="left-box">
                <a routerLink="/dashboard/projects" class="btn-back">
                    <span class="material-icons">arrow_back</span>
                </a>
                <div class="icon-circle" [style.background]="project()?.color">
                    {{ getInitials(project()?.name) }}
                </div>
                <div class="info">
                    <h1>{{ project()?.name }}</h1>
                    <p>{{ project()?.description }}</p>
                </div>
            </div>
            <div class="actions">
                <button class="btn-invite" (click)="showInviteModal.set(true)"
                    *ngIf="currentUserRole() === 'OWNER' || currentUserRole() === 'ADMIN'">
                    <span class="material-icons">person_add</span>
                    Inviter
                </button>
                <div class="project-members-stack">
                    <div class="m-avatar" *ngFor="let m of project()?.members" [title]="m.username">
                        {{ m.username[0].toUpperCase() }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="detail-grid">
        <!-- Sidebar / Members -->
        <aside class="side-panel">
            <div class="panel-card">
                <h3>Membres de l'équipe</h3>
                <div class="member-list">
                    <div class="member-item" *ngFor="let m of project()?.members">
                        <div class="m-icon">{{ m.username[0].toUpperCase() }}</div>
                        <div class="m-info">
                            <span class="m-name">{{ m.username }}</span>
                            <span class="m-role" *ngIf="m.id === project()?.ownerId">Propriétaire</span>
                            <div class="role-editor" *ngIf="m.id !== project()?.ownerId">
                                <span class="m-role" *ngIf="currentUserRole() !== 'OWNER'">
                                    {{ m.ProjectMember?.role === 'ADMIN' ? 'Admin' : 'Membre' }}
                                </span>
                                <select *ngIf="currentUserRole() === 'OWNER'" [ngModel]="m.ProjectMember?.role"
                                    (ngModelChange)="changeMemberRole(m.id, $event)" class="role-select-compact">
                                    <option value="MEMBER">Membre</option>
                                    <option value="ADMIN">Admin</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel-card" *ngIf="currentUserRole() !== 'MEMBER'">
                <h3>Invitations du projet</h3>
                <div class="invitation-list">
                    <div class="invite-item" *ngFor="let inv of project()?.invitations">
                        <span class="material-icons">mail</span>
                        <div class="invite-details">
                            <span class="email-text">{{ inv.email }}</span>
                            <span class="invite-role">{{ inv.role }}</span>
                        </div>
                        <span class="badge-status" [class]="inv.status.toLowerCase()">{{ inv.status }}</span>
                    </div>
                    <div *ngIf="project()?.invitations?.length === 0" class="empty-invites">
                        Aucune invitation en cours.
                    </div>
                </div>
            </div>
        </aside>

        <!-- Tasks Content -->
        <section class="main-panel">
            <div class="panel-header">
                <h2>Tâches du projet</h2>
                <button class="btn-add-task" (click)="openAddTask()"
                    *ngIf="currentUserRole() === 'OWNER' || currentUserRole() === 'ADMIN'">
                    <span class="material-icons">add_task</span>
                    Nouvelle tâche
                </button>
            </div>

            <div class="task-board">
                <div class="task-column">
                    <div class="column-header">
                        <span class="dot todo"></span>
                        À FAIRE ({{ (tasks() | filterStatus:'TODO').length }})
                    </div>
                    <div class="task-list-modern">
                        <div class="task-card-modern" *ngFor="let t of tasks() | filterStatus:'TODO'" [@fadeSlide]
                            (click)="openEditTask(t)">
                            <h4>{{ t.title }}</h4>
                            <p>{{ t.description }}</p>
                            <div class="card-meta">
                                <span class="priority" [class]="t.priority">{{ t.priority }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="task-column">
                    <div class="column-header">
                        <span class="dot progress"></span>
                        EN COURS ({{ (tasks() | filterStatus:'IN_PROGRESS').length }})
                    </div>
                    <div class="task-list-modern">
                        <div class="task-card-modern" *ngFor="let t of tasks() | filterStatus:'IN_PROGRESS'"
                            [@fadeSlide] (click)="openEditTask(t)">
                            <h4>{{ t.title }}</h4>
                            <div class="card-meta">
                                <span class="priority" [class]="t.priority">{{ t.priority }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="task-column">
                    <div class="column-header">
                        <span class="dot done"></span>
                        TERMINÉ ({{ (tasks() | filterStatus:'DONE').length }})
                    </div>
                    <div class="task-list-modern">
                        <div class="task-card-modern" *ngFor="let t of tasks() | filterStatus:'DONE'" [@fadeSlide]
                            (click)="openEditTask(t)">
                            <h4>{{ t.title }}</h4>
                            <div class="card-meta">
                                <span class="priority done">Terminée</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- MODAL INVITE (PREMIUM) -->
    <div class="modal-overlay" *ngIf="showInviteModal()" (click)="showInviteModal.set(false)" [@fadeSlide]>
        <div class="modal-content invite-modal-premium" (click)="$event.stopPropagation()">
            <div class="modal-header-icon">
                <span class="material-icons">send</span>
            </div>
            <h2>Inviter un membre</h2>
            <p>Envoyez une invitation par email pour rejoindre <strong>"{{ project()?.name }}"</strong>.</p>

            <div class="invite-form-modern">
                <div class="input-label">Email du collaborateur</div>
                <div class="input-with-icon" [class.invalid]="inviteEmail().length > 0 && !isEmailValid()">
                    <span class="material-icons">alternate_email</span>
                    <input type="email" [ngModel]="inviteEmail()" (ngModelChange)="inviteEmail.set($event)"
                        placeholder="collegue@exemple.com" autofocus>
                </div>
                <div class="validation-msg" *ngIf="inviteEmail().length > 0 && !isEmailValid()">
                    Adresse email invalide
                </div>

                <div class="input-label" style="margin-top: 20px;">Rôle dans le projet</div>
                <div class="role-selector-modern">
                    <button [class.active]="inviteRole() === 'MEMBER'" (click)="inviteRole.set('MEMBER')">
                        <span class="material-icons">person_outline</span>
                        <span>Membre</span>
                    </button>
                    <button [class.active]="inviteRole() === 'ADMIN'" (click)="inviteRole.set('ADMIN')">
                        <span class="material-icons">verified_user</span>
                        <span>Admin</span>
                    </button>
                </div>
            </div>

            <div class="modal-actions-premium">
                <button class="btn-cancel" (click)="showInviteModal.set(false)">Annuler</button>
                <button class="btn-send" (click)="sendInvite()" [disabled]="!isEmailValid()">
                    <span>Envoyer l'invitation</span>
                    <span class="material-icons">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>

    <!-- TASK DETAIL MODAL -->
    <div class="modal-overlay" *ngIf="showTaskModal()" (click)="closeTaskModal()" [@fadeSlide]>
        <div class="modal-content task-modal" (click)="$event.stopPropagation()">
            <app-task-detail [task]="selectedTask()" [isNew]="isNewTask()" [projectId]="projectId"
                [ownerId]="project()?.ownerId" [userRole]="currentUserRole()" (closeEvent)="closeTaskModal()"
                (updateEvent)="onTaskUpdated()">
            </app-task-detail>
        </div>
    </div>
</div>